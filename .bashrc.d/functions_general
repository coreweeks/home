#!/bin/bash

# check into bash completion with functions:
# <https://ubuntuforums.org/showthread.php?t=733397>
# <https://unix.stackexchange.com/questions/4219/how-do-i-get-bash-completion-for-command-aliases/4220#4220>
# <https://www.tldp.org/LDP/abs/html/tabexpansion.html>

for func in $(realpath $(dirname "$BASH_SOURCE"))/functions/*; do
   [[ -d "$func" ]] && continue
   funcname="$(sed -rne '3 s;^(function\s+)?([^#( ]+)\(\) \{$;\2;p' "$func")"

   # export all the functions here so subshells can utilize them, if needed
   # for some reason, exported pushd() causes issues in direnv-allowed directories
   # though simply sourced (and not exported) pushd() is fine
   # also, we don't want to source and export files with functions that don't match their filenames
   {
      # test conditions
      [[ "$funcname" =~ ^${func//*\/}$ ]] &&
      [[ -r "$file" ]] &&
      file -L --mime-type "$file" | grep -q 'text/x-shellscript' &&
      bash -n "$func" 2>/dev/null
   } && {
      # export the function
      type -t funcname && unset -f funcname
      . "$func" &&
      [[ ! "$func" =~ pushd ]] &&
      export -f "$funcname"
   }
done
unset func
